{% load static %}
{% load i18n %}

{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="rtl">
<head>
    <meta charset="UTF-8">
    {% if LANGUAGE_CODE == 'he' %}
    <title>{% trans "Interactive Map" %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- 住驻专转 爪 砖砖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

    <!-- MapLibre CSS -->
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.3.1/dist/maplibre-gl.min.css" rel="stylesheet" />

    <!-- CSS 驻专 -->
    <link rel="stylesheet" href="{% static 'mapapp/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'mapapp/css/modal.css' %}">
    <link rel="icon" href="{% static 'mapapp/favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
    {% else %}
    <title>{% trans "Interactive Map" %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Third-party libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

    <!-- MapLibre CSS -->
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.3.1/dist/maplibre-gl.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'mapapp/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'mapapp/css/modal.css' %}">
    <link rel="icon" href="{% static 'mapapp/favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
    {% endif %}
</head>
<body>
    <!-- Navbar -->
    <nav>
        <div class="nav-buttons">
            <!-- 驻砖  (爪 ) -->
            <div class="simple-search">
                <input type="text" id="countrySearch" 
                       placeholder="{% if LANGUAGE_CODE == 'he' %}驻砖 ...{% else %}Search Country...{% endif %}" 
                       aria-label="{% if LANGUAGE_CODE == 'he' %}驻砖 {% else %}Country Search{% endif %}">
                <div id="searchResults" class="search-results"></div>
                <!-- 驻转专 驻砖  -->
                <button id="soldier-search-toggle" class="nav-button" 
                        title="{% if LANGUAGE_CODE == 'he' %}驻砖 {% else %}Search Soldiers{% endif %}">
                    <i class="fas fa-user-alt"></i>
                    {% if LANGUAGE_CODE == 'he' %}
                        驻砖 
                    {% else %}
                        Search Soldiers
                    {% endif %}
                </button>
                <!-- 驻转专  转 -->
                <a href="{% url 'dashboard' %}" class="nav-button">
                    <i class="fas fa-tachometer-alt"></i>
                    {% if LANGUAGE_CODE == 'he' %}
                         转
                    {% else %}
                        Dashboard
                    {% endif %}
                </a>
            </div>
            
            <div class="right-side-buttons">
                <!-- 驻转专 专 -->
                <a href="{% url 'home' %}" class="nav-button" id="back-button">
                    <i class="fas fa-arrow-right"></i>
                    {% if LANGUAGE_CODE == 'he' %}
                        专
                    {% else %}
                        Back
                    {% endif %}
                </a>

                <!-- 驻转专 驻转 砖驻 -->
                <form method="POST" action="{% url 'set_language' %}" style="margin: 0;">
                    {% csrf_token %}
                    {% if LANGUAGE_CODE == 'he' %}
                        <input type="hidden" name="language" value="en">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="flag-button" title="Switch to English">
                            <img src="{% static 'mapapp/images/flag_us.png' %}" alt="English">
                        </button>
                    {% else %}
                        <input type="hidden" name="language" value="he">
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="flag-button" title="注专 注专转">
                            <img src="{% static 'mapapp/images/flag_il.png' %}" alt="注专转">
                        </button>
                    {% endif %}
                </form>
                <!-- 驻转专 Dark Mode -->
                <button id="dark-mode-toggle" class="flag-button" title="Dark Mode">
                    
                </button>
                
                <!-- 驻转专 爪专  -->
                <button id="timeline-toggle" class="nav-button" data-action="timeline">
                    <i class="fas fa-clock"></i>
                    {% if LANGUAGE_CODE == 'he' %}
                        爪专 
                    {% else %}
                        Timeline
                    {% endif %}
                </button>
            </div>
        </div>
    </nav>

    <!-- 住 注 -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <h1 class="loading-title">
                {% if LANGUAGE_CODE == 'he' %}
                    注 驻 专拽转
                {% else %}
                    Loading Interactive Map
                {% endif %}
            </h1>
            <div class="loading-spinner"></div>
            <div class="loading-progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="loadingText" class="loading-text">
                {% if LANGUAGE_CODE == 'he' %}
                    注 转 驻...
                {% else %}
                    Loading map...
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Timeline Fixed Container 爪 砖 (住转专 专专转 ) -->
    <div id="timeline-fixed-container" style="display: none;">
        <button id="timeline-close-btn" 
                title="{% if LANGUAGE_CODE == 'he' %}住专 爪专 {% else %}Close Timeline{% endif %}"></button>
        <div id="timeline-container">
            <div class="timeline-header"></div>
            <div id="timeline-events" class="timeline-events"></div>
        </div>
    </div>

    <div class="main-container">
        <header class="map-header">
            <div class="logo-container">
                <a href="{% url 'home' %}">
                    <img src="{% static 'mapapp/images/logo.svg' %}" alt=" ">
                </a>
                <span class="logo-text">
                    {% if LANGUAGE_CODE == 'he' %}
                          
                    {% else %}
                        Jewish Fighter Museum
                    {% endif %}
                </span>
            </div>
            <div class="nav-buttons">
                <form method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="website">
                    <button type="submit">转专 专砖</button>
                </form>
                <form method="POST" action="/i18n/setlang/" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="language" value="he">
                    <button type="submit">注专转</button>
                </form>
                <form method="POST" action="/i18n/setlang/" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="language" value="en">
                    <button type="submit">English</button>
                </form>
            </div>
        </header>
        <div id="map">
            <!--   驻砖, 驻砖 爪 转 navbar -->
        </div>
    </div>

    <!--  砖专 -->
    <div id="eventModal" class="modal">
        <div id="eventContent" class="content">
        <!-- 驻转专 住专 -->
        <div class="modal-controls">
            <button id="eventClose" class="eventClose" onclick="closeModal()">
                <span class="closeText">住专</span>
                <span class="closeX"></span>
            </button>
            </div>

            <div class="modal-layout-grid">
                <!-- Rifht Column -->
                <div class="soldiers-section">
                    <h3 id="soldiersTitle">
                        {% if LANGUAGE_CODE == 'he' %}
                              :
                        {% else %}
                            Fighters from this country:
                        {% endif %}
                    </h3>
                    <div class="soldiers-search-container">
                        <input type="text" id="soldiersSearch" class="soldiers-search" 
                               placeholder="{% if LANGUAGE_CODE == 'he' %}驻砖 ...{% else %}Search fighters...{% endif %}" 
                               aria-label="{% if LANGUAGE_CODE == 'he' %}驻砖 {% else %}Search fighters{% endif %}">
                        <button id="clearSearch" class="clear-search" 
                                aria-label="{% if LANGUAGE_CODE == 'he' %}拽 驻砖{% else %}Clear search{% endif %}"></button>
                        <button id="advancedFilterButton" class="advanced-filter-button" 
                                title="{% if LANGUAGE_CODE == 'he' %}住 转拽{% else %}Advanced Filter{% endif %}">
                            <i class="filter-icon">锔</i>
                        </button>
                    </div>
                    
                    <div id="advancedFilters" class="advanced-filters">
                        <form id="filterForm" class="filter-form">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="genderFilter">
                                        {% if LANGUAGE_CODE == 'he' %}专:{% else %}Gender:{% endif %}
                                    </label>
                                    <select id="genderFilter">
                                        <option value="">{% if LANGUAGE_CODE == 'he' %}{% else %}All{% endif %}</option>
                                        <option value="专">{% if LANGUAGE_CODE == 'he' %}专{% else %}Male{% endif %}</option>
                                        <option value="拽">{% if LANGUAGE_CODE == 'he' %}拽{% else %}Female{% endif %}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="yearFromFilter">
                                        {% if LANGUAGE_CODE == 'he' %}砖转 :{% else %}From birth year:{% endif %}
                                    </label>
                                    <input type="number" id="yearFromFilter" min="1900" max="1945" 
                                           placeholder="{% if LANGUAGE_CODE == 'he' %}...{% else %}From...{% endif %}">
                                </div>
                                
                                <div class="filter-group">
                                    <label for="yearToFilter">
                                        {% if LANGUAGE_CODE == 'he' %}注 砖转 :{% else %}To birth year:{% endif %}
                                    </label>
                                    <input type="number" id="yearToFilter" min="1900" max="1945" 
                                           placeholder="{% if LANGUAGE_CODE == 'he' %}注...{% else %}To...{% endif %}">
                                </div>
                            </div>
                            
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="sortByFilter">
                                        {% if LANGUAGE_CODE == 'he' %} 驻:{% else %}Sort by:{% endif %}
                                    </label>
                                    <select id="sortByFilter">
                                        <option value="name">{% if LANGUAGE_CODE == 'he' %}砖{% else %}Name{% endif %}</option>
                                        <option value="birth_date">{% if LANGUAGE_CODE == 'he' %}转专 {% else %}Birth Date{% endif %}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-buttons">
                                <button type="button" id="applyFilters" class="apply-filters-btn">
                                    {% if LANGUAGE_CODE == 'he' %} 住{% else %}Apply Filter{% endif %}
                                </button>
                                <button type="button" id="resetFilters" class="reset-filters-btn">
                                    {% if LANGUAGE_CODE == 'he' %}驻住{% else %}Reset{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="soldiersContainer" class="soldiers-list scrollable"></div>
                </div>

                <!-- Middle Column -->
                <div class="passport">
                    <caption class="event-caption">
                        <div class="caption-wrapper">
                            <span id="eventTitle" class="uppercase">砖 专注</span>
                            <div id="insetMapPlaceholder" class="map-placeholder">
                                <img id="countryFlag" src="" alt=" ">
                            </div>
                        </div>
                    </caption>
                    
                    <!-- Event Cards Container -->
                    <div id="eventsContainer" class="events-cards-container">
                        <!-- Events will be dynamically added here as cards -->
                    </div>

                    <!-- Event Details Section -->
                    <div id="eventDetails" class="event-details">
                        <div class="event-description">
                            {% if LANGUAGE_CODE == 'he' %}
                            <h3>转专 专注</h3>
                            {% else %}
                            <h3>Event Description</h3>
                            {% endif %}
                            <div id="eventSummary" class="scrollable">
                                <!-- Event description will be added here -->
                                <div class="event-info">
                                    <div class="info-row">
                                        <strong>转专 转:</strong>
                                        <span id="startDate">25/08/1941</span>
                                    </div>
                                    <div class="info-row">
                                        <strong>转专 住:</strong>
                                        <span id="endDate">30/08/1941</span>
                                    </div>
                                    <div class="info-row">
                                        <strong>拽:</strong>
                                        <span id="location">专</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!--  驻专  -->
    <div id="soldierModal" class="modal">
        <div id="soldierContent" class="content">
            <!-- 驻转专 住专 -->
            <div class="modal-controls">
                <button id="soldierClose" class="eventClose" onclick="closeSoldierModal()">
                    <span class="closeText">{% if LANGUAGE_CODE == 'he' %}住专{% else %}Close{% endif %}</span>
                    <span class="closeX"></span>
                </button>
            </div>

            <div class="soldier-layout-grid">
                <!-- Soldier Profile - Full Width -->
                <div class="soldier-profile-full">
                    <div class="soldier-header">
                        <div class="soldier-avatar">
                            <img id="soldierImage" src="" alt="转转 ">
                        </div>
                        <div class="soldier-title">
                            <h2 id="soldierName" class="uppercase"></h2>
                            <div id="soldierBadge" class="badge"></div>
                        </div>
                    </div>

                    <div class="soldier-details scrollable">
                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}驻专 砖{% else %}Personal Details{% endif %}</h3>
                            <div class="details-grid">
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}转专 :{% else %}Birth Date:{% endif %}</strong>
                                    <span id="soldierBirthDate"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}注专 :{% else %}Birth City:{% endif %}</strong>
                                    <span id="soldierBirthCity"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}转 :{% else %}Birth Country:{% endif %}</strong>
                                    <span id="soldierBirthCountry"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}砖 :{% else %}Father's Name:{% endif %}</strong>
                                    <span id="soldierFatherName"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}砖 :{% else %}Mother's Name:{% endif %}</strong>
                                    <span id="soldierMotherName"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}砖 砖驻 拽:{% else %}Previous Last Name:{% endif %}</strong>
                                    <span id="soldierPreviousLastName"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}:{% else %}Nickname:{% endif %}</strong>
                                    <span id="soldierNickname"></span>
                                </div>
                            </div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}砖专转 爪{% else %}Military Service{% endif %}</h3>
                            <div class="details-grid">
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}爪:{% else %}Army:{% endif %}</strong>
                                    <span id="soldierArmy"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}转驻拽:{% else %}Role:{% endif %}</strong>
                                    <span id="soldierRole"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}专:{% else %}Rank:{% endif %}</strong>
                                    <span id="soldierRank"></span>
                                </div>
                            </div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}砖转转驻转 {% else %}War Participation{% endif %}</h3>
                            <div id="soldierParticipation" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}注专{% else %}Decorations{% endif %}</h3>
                            <div id="soldierDecorations" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}专驻{% else %}Biography{% endif %}</h3>
                            <div id="soldierBiography" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}转专 {% else %}Fighting Description{% endif %}</h3>
                            <div id="soldierFightingDesc" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}转专 {% else %}Ghetto Description{% endif %}</h3>
                            <div id="soldierGettoDesc" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}驻爪注转{% else %}Wounds{% endif %}</h3>
                            <div id="soldierWounds" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}注 注 驻专{% else %}Death Information{% endif %}</h3>
                            <div class="details-grid">
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}转专 驻专:{% else %}Death Date:{% endif %}</strong>
                                    <span id="soldierDeathDate"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}拽 驻专:{% else %}Place of Death:{% endif %}</strong>
                                    <span id="soldierDeathPlace"></span>
                                </div>
                            </div>
                            <div id="soldierDeathDetails" class="text-block"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--  驻砖  -->
    <div id="soldierSearchModal" class="modal">
        <div class="modal-content soldier-search-modal">
            <div class="modal-header">
                <h2>{% if LANGUAGE_CODE == 'he' %}驻砖 {% else %}Search Soldiers{% endif %}</h2>
                <button class="close-button" onclick="closeSoldierSearchModal()"></button>
            </div>
            <div class="modal-body">
                <div class="search-input-container">
                    <input type="text" id="soldierSearchInput" 
                           placeholder="{% if LANGUAGE_CODE == 'he' %}拽 砖 ...{% else %}Type soldier name...{% endif %}" 
                           autofocus>
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div id="soldierSearchResults" class="soldier-search-results"></div>
            </div>
        </div>
    </div>

    <!-- MapLibre JS -->
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.3.1/dist/maplibre-gl.min.js"></script>

    <!-- 专转 驻转转 API 爪专  -->
    <script>
        // Global configuration for production
        window.WW2_CONFIG = {
            MAPTILER_API_KEY: '{{ MAPTILER_API_KEY|default:"" }}',
            GEMINI_API_KEY: '{{ GEMINI_API_KEY|default:"" }}',
            DEBUG: {% if DEBUG %}true{% else %}false{% endif %},
            APP_NAME: 'WW2 Map',
            VERSION: '1.0.0',
            SUPPORTED_LANGUAGES: ['he', 'en']
        };
    </script>
    
    <!-- 拽抓 JS 专砖 -->
    <script type="module" src="{% static 'mapapp/js/index.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const openBtn = document.getElementById('timeline-open-btn');
            const closeBtn = document.getElementById('timeline-close-btn');
            const timelineToggle = document.getElementById('timeline-toggle');
            const timelineFixed = document.getElementById('timeline-fixed-container');
            const navbar = document.querySelector('nav');
            
            // 驻转/住专 注 驻转专 navbar
            if (timelineToggle && timelineFixed && navbar) {
                timelineToggle.addEventListener('click', function() {
                    if (timelineFixed.style.display === 'none' || timelineFixed.style.display === '') {
                        timelineFixed.style.display = 'flex';
                        timelineToggle.classList.add('active');
                        navbar.classList.add('timeline-open');
                        if (openBtn) openBtn.style.display = 'none';
                    } else {
                        timelineFixed.style.display = 'none';
                        timelineToggle.classList.remove('active');
                        navbar.classList.remove('timeline-open');
                        if (openBtn) openBtn.style.display = 'block';
                    }
                });
            }
            
            // 驻转 注 驻转专 爪祝 ( 拽)
            if (openBtn && timelineFixed && navbar) {
                openBtn.addEventListener('click', function() {
                    timelineFixed.style.display = 'flex';
                    openBtn.style.display = 'none';
                    navbar.classList.add('timeline-open');
                    if (timelineToggle) timelineToggle.classList.add('active');
                });
            }
            
            // 住专 注 驻转专 X
            if (closeBtn && timelineFixed && navbar) {
                closeBtn.addEventListener('click', function() {
                    timelineFixed.style.display = 'none';
                    navbar.classList.remove('timeline-open');
                    if (openBtn) openBtn.style.display = 'block';
                    if (timelineToggle) timelineToggle.classList.remove('active');
                });
            }
        });
    </script>
    <script src="{% static 'mapapp/js/map.js' %}"></script>
</body>
</html>
